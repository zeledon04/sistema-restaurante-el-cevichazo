{% load static %}
<header class="h-[7vh] md:h-[10vh] border-b relative p-8 flex justify-between items-center">
  <div class="flex items-center space-x-3">
    <img src="{% static 'image/logo.png' %}" alt="El Cevichazo" class="h-12 w-12 rounded-full">
    <div>
      <h1 class="text-xl font-bold text-slate-800">El Cevichazo</h1>
      <p class="text-sm text-amber-600">¡El sabor que me gusta!</p>
    </div>
  </div>
  <nav class='flex items-center gap-2'>

    <button onclick="mostrarVentana()" aria-label="Notificaciones" id="btnCampana" class="relative hover:bg-gray-200 hover:cursor-pointer active:bg-gray-300 p-2 rounded-lg transition-colors">
      
      <svg class="size-6 text-slate-800" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0" />
      </svg>
      
      {% if numeroNotificaciones >= 1 and numeroNotificaciones < 10 %}
      <span class='absolute -top-0.5 right-0 bg-orange-500 py-0.5 px-[5px] box-content text-slate-800 rounded-lg text-[9px] font-bold'>
        {{ numeroNotificaciones }}
      </span>
      {% elif numeroNotificaciones > 9 %}
      <span class='absolute -top-0.5 right-0 bg-orange-500 py-0.5 px-[5px] box-content text-slate-800 rounded-lg text-[9px] font-bold'>
        9+
      </span>
      {% else %}
      <span class='absolute -top-0.5 right-0 bg-orange-500 py-0.5 px-[5px] box-content text-slate-800 rounded-lg text-[9px] font-bold'>
        0
      </span>
      {% endif %}
    
    </button>

    <!-- Overlay y ventana emergente -->
    <div id="overlay" class="fixed inset-0 bg-opacity-40 hidden z-40">
      
      <div onclick="event.stopPropagation()" class="absolute top-15 right-10 bg-gray-100 border-gray-300 border-1 rounded-lg shadow-lg p-4 w-[26rem] max-h-[80vh] z-50">
        <h1 class='text-gray-950 text-center font-medium'>
          {% comment %} Notificaciones ({{ numeroNotificaciones }}) {% endcomment %}
          Notificaciones ({{ numeroNotificaciones }})
        </h1>

        <hr class='my-2 mt-5 border-gray-300 px-5' />

        <div class="max-h-[70vh] overflow-y-auto">

          <!-- Esto para las notificaciones en verdes que me dijiste, Jair, que tenían que ir para notificar listo plato CREEOOOO -->
          
          {% for notificacion in platosListos %}
          <div class='p-0 hover:bg-transparent hover:cursor-pointer'>
            <a to="/" class='flex flex-1 items-center gap-4 py-2 px-4 hover:bg-gray-300 transition-colors rounded-lg'>

              <svg class="size-6 text-4xl p-2 rounded-lg box-content bg-green-500/10 text-green-500" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
              </svg>

              <div class='text-sm flex flex-col w-full'>
                <div class='flex items-center justify-between gap-4'>
                  <span class='text-black'>{{ notificacion.nombreplato }}</span>
                  <span class='text-[12px] text-gray-700'>{{ notificacion.nombreomesa }}</span>    
                </div>
                <div class='flex items-center justify-between gap-4'>
                  <p class='truncate text-green-500 text-xs font-semibold'>¡LISTO!</p>
                  <span class='text-xs text-green-600 font-bold'>Ya puedes servirlo</span>
                </div>
              </div>
            </a>
          </div>
          {% endfor %}

          {% for notificacion in platosPendientes %}
          <div class='p-0 hover:bg-transparent hover:cursor-pointer'>
            <a to="/" class='flex flex-1 items-center gap-4 py-2 px-4 hover:bg-gray-300 transition-colors rounded-lg'>
              <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-4xl p-2 rounded-lg box-content bg-yellow-500/10 text-yellow-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126ZM12 15.75h.007v.008H12v-.008Z" />
              </svg>
              <div class='text-sm flex flex-col w-full'>
                <div class='flex items-center justify-between gap-4'>
                  <span class='text-black'>{{ notificacion.nombreplato }}</span>
                  <span class='text-[12px] text-gray-700'>{{ notificacion.nombreomesa }}</span>    
                </div>
                <div class='flex items-center justify-between gap-4'>
                  <p class='truncate text-yellow-500 text-xs font-semibold'>¡Pendiente de entrar a cocina!</p>
                  <span class='text-xs text-yellow-600 font-bold  tiempo-transcurrido' data-hora="{{ notificacion.hora|date:'c' }}"></span>
                </div>
              </div>
            </a>
          </div>
          {% endfor %}
          
          {% for notisficacion in platosPreparacion %}
          <div class='p-0 hover:bg-transparent hover:cursor-pointer'>
            <a to="/" class='flex flex-1 items-center gap-4 py-2 px-4 hover:bg-gray-300 transition-colors rounded-lg'
            data-hora="{{ notisficacion.hora|date:'Y-m-d H:i:s' }}"
            data-tiempo="{{ notisficacion.tiempo_estimado }}">
              <svg class="size-6 text-4xl p-2 rounded-lg box-content bg-blue-500/10 text-blue-500" fill="currentColor" viewBox="0 0 512 512">
                <g>
                  <path class="st0" d="M426.083,189.826c14.682-14.659,23.81-35.083,23.803-57.47c-0.016-44.894-36.372-81.25-81.265-81.265   c-7.561,0-14.887,1.106-21.864,3.061c-7.273-13.416-17.356-25.053-29.552-34.053C300.113,7.484,278.856-0.008,256,0   c-22.856-0.008-44.113,7.484-61.204,20.098c-12.197,9-22.28,20.637-29.561,34.053c-6.969-1.955-14.288-3.061-21.848-3.061   c-44.894,0.008-81.265,36.371-81.273,81.265c-0.007,22.387,9.121,42.811,23.803,57.47c11.803,11.819,27.387,19.947,44.689,22.697   v78.212c-13.19,21.94-20.886,47.523-20.886,74.978C109.72,446.5,175.212,512,256,512c80.78,0,146.273-65.5,146.273-146.288   c0-27.455-7.697-53.038-20.886-74.978v-78.212C398.697,209.78,414.28,201.651,426.083,189.826z M256,476.59   c-59.765,0-108.515-47.59-110.666-106.826c22.424-2.272,74.432-12.999,116.303-62.788h4.181l-3.924,0.69   c30.848,32.56,80.652,54.992,104.636,64.515C363.144,430.296,314.932,476.59,256,476.59z M110.538,99.515   c8.462-8.424,19.962-13.59,32.848-13.598c8.212,0.008,15.818,2.121,22.53,5.856l18.44,10.273l6.575-20.06   c4.478-13.66,13.174-25.485,24.538-33.856c11.371-8.371,25.288-13.296,40.53-13.296c15.242,0,29.152,4.924,40.53,13.296   c11.356,8.371,20.053,20.197,24.522,33.856l6.576,20.068l18.447-10.28c6.728-3.735,14.326-5.848,22.546-5.856   C381.5,85.924,393,91.091,401.462,99.515c8.424,8.455,13.591,19.963,13.598,32.841c-0.008,12.871-5.174,24.379-13.598,32.833   c-8.462,8.439-19.962,13.599-32.841,13.607c-0.667,0.007-1.75-0.068-3.356-0.19l-18.712-1.401v102.598H165.439V177.197   l-18.72,1.409c-1.591,0.122-2.682,0.197-3.334,0.19c-12.886-0.008-24.386-5.168-32.848-13.607   c-8.424-8.454-13.591-19.962-13.598-32.833C96.947,119.478,102.114,107.97,110.538,99.515z"/>
                </g>
              </svg>
              
              <div class='text-sm flex flex-col w-full'>
                <div class='flex items-center justify-between gap-4'>

                  <span class='text-black'>{{ notisficacion.nombreplato }}</span>
                  <span class='text-[12px] text-gray-700'>{{ notisficacion.nombreomesa }}</span>

                </div>
                <div class='flex items-center justify-between gap-4'>
                  <p class='truncate text-blue-500 text-xs font-semibold'>¡En Preparacion!</p>
                  <span class='text-xs text-blue-600 font-bold tiempo-restante'></span>
                </div>
              </div>
            </a>
          </div>
          {% endfor %}


          {% for notisficacion in notisStock %}
          <div class='p-0 hover:bg-transparent hover:cursor-pointer'>
            <a to="/" class='flex flex-1 items-center gap-4 py-2 px-4 hover:bg-gray-300 transition-colors rounded-lg'>
              <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-4xl p-2 rounded-lg box-content bg-red-500/10 text-red-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
              </svg>
              <div class='text-sm flex flex-col w-full'>
                <div class='flex items-center justify-between gap-4'>

                  <span class='text-black'>{{ notisficacion.nombre }}</span>
                  <span class='text-[12px] text-gray-700'>Stock: {{ notisficacion.stock }}</span>
                </div>
                <p class='truncate text-red-500 text-xs font-semibold'>Stock Bajo</p>
              </div>
            </a>
          </div>
         {% endfor %}

          {% for notisficacion in notisVencimiento %}
          <div class='p-0 hover:bg-transparent hover:cursor-pointer'>
            <a to="/" class='flex flex-1 items-center gap-4 py-2 px-4 hover:bg-gray-300 transition-colors rounded-lg'>
              <svg fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6 text-4xl p-2 rounded-lg box-content bg-red-500/10 text-red-500">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
              </svg>
              <div class='text-sm flex flex-col w-full'>
                <div class='flex items-center justify-between gap-4'>

                  <span class='text-black'>{{ notisficacion.nombre }}</span>
                  <span class='text-[12px] text-gray-700'>Fecha: {{ notisficacion.fecha_vencimiento }}</span>
                </div>
                <p class='truncate text-red-500 text-xs font-semibold'>Expira Pronto</p>
              </div>
            </a>
          </div>
         {% endfor %}
        
        </div>

        

      </div>
    </div>

  </nav>
</header>

<script>
  function actualizarTiemposRestantes() {
    const items = document.querySelectorAll('a[data-hora][data-tiempo]');
    const ahora = new Date();

    items.forEach(item => {
      const horaInicio = new Date(item.dataset.hora);
      const tiempoEstimado = parseInt(item.dataset.tiempo);

      const finEstimado = new Date(horaInicio.getTime() + tiempoEstimado * 60000);
      const diffMs = finEstimado - ahora;

      const spanTiempo = item.querySelector('.tiempo-restante');

      if (diffMs > 0) {
        const minutos = Math.floor(diffMs / 60000);
        const segundos = Math.floor((diffMs % 60000) / 1000);
        spanTiempo.textContent = `Estimado ${minutos}m ${segundos}s`;
      } else {
        spanTiempo.textContent = "¡LISTO!";
        spanTiempo.classList.remove('text-red-600');
        spanTiempo.classList.add('text-green-600');
      }
    });
  }

  // Ejecutar cada segundo
  setInterval(actualizarTiemposRestantes, 1000);
  document.addEventListener("DOMContentLoaded", actualizarTiemposRestantes);
</script>

<script>
  function actualizarTiempos() {
    const spans = document.querySelectorAll('.tiempo-transcurrido');

    spans.forEach(span => {
      const horaStr = span.getAttribute('data-hora');
      const horaEntrada = new Date(horaStr); // convierte la hora enviada por Django
      const ahora = new Date();

      const diffMs = ahora - horaEntrada; // diferencia en milisegundos
      const diffMin = Math.floor(diffMs / 60000); // convierte a minutos
      const diffSeg = Math.floor((diffMs % 60000) / 1000); // segundos restantes

      span.textContent = `${diffMin}m ${diffSeg}s`;
    });
  }

  // Llama la función cada segundo
  setInterval(actualizarTiempos, 1000);

  // Llama una vez al cargar
  actualizarTiempos();
</script>

